# Raptor Traffic Recording/Replay Docker Compose
# Service: demo-service
# Generated by TARS - Test Automation and Review System

version: '3.8'

services:
  # Raptor proxy for recording traffic
  raptor-proxy:
    image: raptor/proxy:latest
    container_name: demo-service-raptor-proxy
    ports:
      - "9080:9080"   # Proxy port (send traffic here)
      - "9081:9081"   # Admin/API port
    environment:
      - RAPTOR_TARGET_HOST=${TARGET_HOST:-host.docker.internal}
      - RAPTOR_TARGET_PORT=${TARGET_PORT:-8080}
      - RAPTOR_RECORDING_ENABLED=true
      - RAPTOR_STORAGE_PATH=/recordings
    volumes:
      - ./raptor/raptor.yml:/config/raptor.yml:ro
      - ./raptor/filters:/config/filters:ro
      - ./raptor/recordings:/recordings
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9081/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Raptor replay service
  raptor-replay:
    image: raptor/replay:latest
    container_name: demo-service-raptor-replay
    profiles:
      - replay
    ports:
      - "9082:9082"   # Replay control port
    environment:
      - RAPTOR_TARGET_HOST=${TARGET_HOST:-host.docker.internal}
      - RAPTOR_TARGET_PORT=${TARGET_PORT:-8080}
      - RAPTOR_RECORDINGS_PATH=/recordings
      - RAPTOR_REPORTS_PATH=/reports
    volumes:
      - ./raptor/replay.yml:/config/replay.yml:ro
      - ./raptor/recordings:/recordings:ro
      - ./raptor/reports:/reports
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - raptor-proxy

  # Optional: Target service (your application)
  demo-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: demo-service-app
    profiles:
      - with-app
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=${PROFILE:-default}

# Networks
networks:
  default:
    name: raptor-network

# Volumes for persistence
volumes:
  raptor-recordings:
  raptor-reports:
